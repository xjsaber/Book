# 许式伟的架构课 #

开篇词

## 开篇词 | 怎样成长为优秀的软件架构师？ ##

那怎么才能成长为优秀的软件架构师？软件架构师和软件工程师最根本的差别又在哪里？我认为关键在于四个字：掌控全局。

基础平台篇

## 01 | 架构设计的宏观视角 ##

### 为什么需要建立宏观视角？ ###

**我们的整个专栏内容也会从基础架构开始讲起，最后逐步过渡到业务架构，到最终完成一个完整应用程序的设计过程。**

从基础架构开始，逐渐来解剖一个应用程序的整体构成

### 应用程序的基础架构 ###

#### 我们想学习一个程序的基础架构，其实就是弄清楚电脑的工作原理，以及程序的运行原理。 ####

所有的电脑都可以统一看作由“**中央处理器 + 存储 + 一系列的输入输出设备**”构成。

中央处理器，也就是我们平常说的 CPU，负责按指令执行命令；存储负责保存数据，包括我们要执行的命令，也是以数据形式保存在存储中的。

每次在打开电脑的电源后，中央处理器都会从存储的某个固定位置处开始读入数据（也就是指令），并且按指令执行命令，执行完一条指令就会继续执行下一条指令。电脑就这样开始工作了。

**那这么简单的话，为何电脑能够完成这么多复杂而多样化的工作？**这整个过程，在我看来主要依赖两点。

1. **第一是可编程性。**大体来说，中央处理器（CPU）的指令分为如下这几类。
	* 计算类，也就是支持我们大家都熟知的各类数学运算，如加减乘除、sin/cos 等等。
	* I/O 类，（从存储读写数据）从输入输出设备读数据、写数据。
	* 指令跳转类，在满足特定条件下跳转到新的当前程序执行位置。
2. **第二是开放设计的外部设备支持。**虽然我们电脑可以连接非常非常多种类的外部设备

从上面可以看出，**电脑的 CPU 是一个非常简洁的模型，它只读入和写出数据，对数据进行计算**。

#### 有了这个基础的计算机体系之后，我们就可以编写软件了。 ####

1. 第一个问题是**直接用机器指令编写软件太累，而且这些机器指令像天书一样没人看得懂，没法维护**。
	* 编程语言 + 编译器：编译器负责把我们人类容易理解的语言，转换为机器可以理解的机器指令，这样一来就大大解放了编写软件的门槛。
2. 我们遇到的第二个问题，**就是多个软件在同一个电脑上怎么共处。多个软件大家往同一个存储地址写数据冲突怎么办？一起往打印机去发送打印指令怎么办？有的软件可能偷偷搞破坏怎么办？**
	* **操作系统**，它首先要解决的是软件治理的问题。操作系统其次解决的是基础编程接口问题。

基础架构解决的是与业务无关的一些通用性的问题，这些问题往往无论你具体要做什么样的应用都需要面对。而且，基础架构通常以独立的软件存在，所以也称为基础软件。

### 完整的程序架构是怎样的？ ###

### 结语 ###

**可能有人看到今天的内容心里会有些担心：“原来架构师要学这么多东西，看来我离成为架构师好远。”**

**而架构能力的提升，本质上是对你的知识脉络（全身经络）的反复梳理与融会贯通的过程。**

这就像你没有从事云计算行业，但是你仍然需要理解云计算的本质，需要驾驭云计算。你也不必去做出一个浏览器，但是你需要理解它们的思考方式，因为你在深度依赖于它们。

## 02 | 大厦基石：无生有，有生万物 ##

### 解剖架构的关键点是什么？ ###

**我们应该如何去分析架构设计中涉及的每一个零部件。换一句话说，当我们设计或分析一个零部件时，我们会关心哪些问题。**

1. 第一个问题，是需求。

2. 第二个问题，是规格。 

### 为“解决一切的问题”而生 ###

### 结语 ###

我们近距离地去解剖了整个信息世界地基：冯·诺依曼体系结构。

冯·诺依曼体系结构的不凡之处在于，它想“解决一切可以用‘计算’来解决的问题”。

为了实现这个目标，冯·诺依曼引入了三类基础零部件：中央处理器、存储、输入输出设备。所有计算机都可以看做由 “中央处理器 + 存储 + 一系列的输入输出设备” 构成。

## 03 | 汇编：编程语言的诞生 ##



桌面开发篇

## 20 | 桌面开发的宏观视角 ##

### 命令行交互 ###



服务端开发篇

## 34 | 服务端开发的宏观视角 ##

### 服务端的发展史 ###



### 服务端程序的需求 ###

#### 1. 规模 ####

* 桌面程序是为单个用户服务的，所以它关注点是用户交互体验的不断升级。
* 服务端程序是被所有用户所共享，为所有用户服务的。一台物理的机器资源总归是有限的，能够服务的用户数必然存在上限，所以一个服务端程序在用户规模到达一定程度后，需要分布式化，跑在多台机器上以服务用户。

#### 2. 连续服务时长 ####

* 桌面程序是为单个用户服务的，用户在单个桌面程序的连续使用时长通常不会太长。
* 但是服务端程序不同，它通常都是 7x24 小时不间断服务的。当用户规模达到一定基数后，每一秒都会有用户在使用它，不存在关闭程序这样的概念。

#### 3. 质量要求。 ####

* 每个桌面程序的实例都是为单个用户服务的，有一亿的用户就有一亿个桌面程序的实例。
* 但是服务端程序不同，不可能有一亿个用户就跑一亿个，每个用户单独用一个，而是很多用户共享使用一个程序实例。

这意味着两者对程序运行崩溃的容忍度不同。

* 一个桌面程序实例运行崩溃，它只影响一个用户。
* 但一个服务端程序实例崩溃，可能影响几十万甚至几百万的用户。

所以，服务端程序必须是多实例的。单个程序实例的临时不可用状态，要做到用户无感知。

### 服务端开发的体系架构 ###

相比桌面程序而言，服务端程序依赖的基础软件不只是操作系统和编程语言，还多了两类：

* 负载均衡（Load Balance）；
* 数据库或其他形式的存储（DB/Storage）。

### 结语 ###

就像桌面的领域特征是强交互，以事件为输入，GDI 为输出一样，服务端的领域特征是大规模的用户请求，以及 24 小时不间断的服务。

这些领域特征直接导致了服务端开发的体系架构和桌面必然是如此的不同。

## 35 | 流量调度和负载均衡 ##

比桌面程序而言，服务端程序依赖的基础软件不只是操作系统和编程语言，还多了两类：

* 负载均衡（Load Balance）；
* 数据库或其他形式的存储（DB/Storage）。

为什么会需要负载均衡（Load Balance）？今天我们就聊一下有关于流量调度与负载均衡的那些事情。

什么是 “流量调度”？我们首先要了解这样几个常见的服务端程序运行实例（进程）相关的概念：

* 连接数；
* IOPS；
* 流量，入向流量和出向流量。

一个基本的服务端程序的服务请求，通常是由一个请求包（Request）和一个应答包（Response）构成。这样一问一答就是一次完整的服务。

连接数，有时候也会被称为并发数，指的是同时在服务中的请求数。也就是那些已经发送请求（Request），但是还没有收完应答（Response）的请求数量。

IOPS，指的是平均每秒完成的请求（一问一答）的数量。它可以用来判断服务端程序的做事效率。

流量分入向流量和出向流量。入向流量可以这么估算：

* 平均每秒收到的请求包（Request）数量 * 请求包平均大小。

同样的，出向流量可以这么估算：

* 平均每秒返回的应答包（Response）数量 * 应答包平均大小。

不考虑存在无效的请求包，也就是存在有问无答的情况（但实际生产环境下肯定是有的）的话，那么平均每秒收到的请求包（Request）数量、平均每秒返回的应答包（Response）数量就是 IOPS。故此：

* 入向流量 ≈ IOPS * 请求包平均大小
* 出向流量 ≈ IOPS * 应答包平均大小

所谓流量调度，就是把海量客户并发的请求包按特定策略分派到不同的服务端程序实例的过程。

### DNS 流量调度 ###

一个域名通过 DNS 解析到多个 IP，每个 IP 对应不同的服务端程序实例。这样就完成了流量调度。这里我们没有用到常规意义的负载均衡（Load Balance）软件，但是我们的确完成了流量调度。

#### 第一个问题，是升级不便 ####

#### 第二个问题，是流量调度不均衡。 ####

### 网络层负载均衡 ###

在网络层（IP 层）做负载均衡。负载均衡软件 LVS（Linux Virtual Server）就工作在这一层。

LVS 支持三种调度模式。

* 




服务治理篇

架构思维篇

软件工程篇

延展阅读

结束语

## 结束语 | 放下技术人的身段，用极限思维提升架构能力 ##

传统的架构图书往往从架构思维开始。但是，我认为它们错了。这里面最关键的问题在于：

*架构并不是 “知识点”。*

架构思维的确非常非常重要。但是，熟读架构思维并不足以让人成为一名优秀的架构师。

武功招式可以精确传授，是 “知识点”，掌握了就是掌握了，理论上可以做到分毫不差。但是，架构不是武功招式。它更像内功，它不是 0 和 1，没有清晰的掌握和没有掌握这样泾渭分明的区别。

### 在架构能力上，没有最好，只有更好。 ###

这是为什么我们的架构课并不是从架构思维开始，而是采用双线结构。它基本上围绕着以下两个脉络主线来展开内容：

* 如何从零开始一步步构建出整个信息世界；
* 在整个信息世界的构建过程中，都用了哪些重要的架构思维范式，以及这些范式如何去运用于你平常的工程实践中。

这两大脉络相辅相成。

1. 通过还原信息世界的构建过程，剥离出了整个信息世界的核心骨架，这也是最真实、最宏大的架构实践案例。
2. 结合这个宏大的架构实践来谈架构思维，避免因对架构思维的阐述过于理论化而让人难以理解。
3. 架构就是对业务系统的正交分解。因此，整个信息科技的演化过程，自然而然形成了分层：基础架构 + 业务架构。

基础架构的产生是对业务架构不断深入理解的过程。越来越多的共性需求从业务架构抽离出来，成为信息科技的基础设施。

作为架构师，我们需要坚持对业务进行正交分解的信念，要坚持不断地探索各类需求的架构分解方法。这样的思考多了，我们就逐步形成了各种各样的架构范式。

这些架构范式，并不仅仅是一些架构思维，而是 “一个个业务只读、接口稳定、易于组合的模块 + 组合的方法论”，它们才是架构师真正的武器库。

这个武器库包含哪些内容？

1. 首先，它应该包括信息科技形成的基础架构：
	1. 其一，基础平台。包括：冯·诺依曼体系、编程语言、操作系统。
	2. 其二，桌面开发平台。包括：窗口系统、GDI 系统、浏览器与小程序。当然我们也要理解桌面开发背后的架构逻辑，MVC 架构。
	3. 其三，服务端开发平台。包括：负载均衡、各类存储中间件。服务端业务开发的业务逻辑比桌面要简单得多。服务端难在如何形成有效的基础架构，其中大部分是存储中间件。
	4. 其四，服务治理平台。主要是以容器技术为核心的 DCOS（数据中心操作系统），以及围绕它形成的整个服务治理生态。这一块还在高速发展过程中，最终它将让服务端开发变得极其简单。
2. 架构师需要放下技术人的身段，学会 “共情”。与用户共情，理解用户的所思所想。与开发人员共情，理解技术人的所思所想。与公司共情，理解公司的发展诉求。
3. 实践对架构能力不可或缺。
	1. 要提升架构能力，首先得做到规格为先，而不是实现为先。不要动不动问怎么实现的。要首先谈这个规格合不合理，是否存在多余的依赖。进一步来说，要多去谈这个函数（或软件实体）的业务范畴合不合理，是否应该换一个切分的姿势。
	2. 其实 review 自己的代码也是一种极佳的架构能力的提升手段。对自己刚刚写完的代码，去 review 它，从中找出问题。如此反复训练，就能实现自我能力的提升。
	3. 很多人追逐实现新的业务系统，通过做新系统来找到满足感。但是实际上对架构师来说，恰恰是反复打磨既有系统是更加锻炼人的。如果你一年前实现的系统今天仍然很满意，那就需要警醒，因为这一年你在原地踏步。

### 在架构能力上，没有最好，只有更好。 ###

架构没有最好，只有更好。在极有限的上机时间里，在没有电脑的情况下，我们只能选择把更多的逻辑装进脑子里。

这个过程还可以更进一步。我们不断训练自己对不同业务领域的架构范式的理解。直至最终，我们头脑中可以装得下整个信息科技的骨架。

到那时，单就架构能力而言，你就是最顶级的架构师了。