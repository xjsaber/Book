# Kafka核心技术与实战 #

# 开篇词 #

## 开篇词 | 为什么要学习Kafka ##


# kafka入门 #

## 01 | 消息引擎系统ABC ##

Apache Kafka是一款开源的消息引擎系统。

* 点对点模型：也叫消息队列模型。
* 发布/订阅模型：有个主题（Topic）的概念，理结成逻辑语义相近的消息容器。该模型也有发送方（发布者）和接收方（订阅者）。可能存在多个发布者相同的主题发送消息，而订阅者也可能存在多个。

系统A不能直接发送消息给消息B，中间还要隔一个消息引擎，是为了“削峰填谷”。

## 02 | 一篇文章带你快速搞定Kafka术语 ##

在Kafka中，发布订阅的对象是主题（Topic）。

向主题发布消息的客户端应用程序称为生产者（Producer），生产者程序通常持续不断地向一个或多个主题发送消息，而订阅这些主题消息的客户端应用程序就被称为消费者。和生产者类似，消费者也能够订阅多个主题的消息。我们把生成者和消费者统称为客户端（Clients）。

### 小结 ###

消息：Record。kafka是消息引擎，这里的消息就是指Kafka处理的主要对象。
主题：Topic。主题是承载消息的逻辑容器。在实际使用终多用来区分具体的业务。
分区：Partition。一个有序不变的消息序列。每个主题中可以有多个分区。
消息位移：Offset。表示分区中同一条消息能够被拷贝到多个地方以提供数据冗余，这些地方就是所谓的副本。副本
副本：Replica。Kafka中同一条消息能够被拷贝到多个地方以提供数据冗余，这些地方都是所谓的副本。副本还分为领导者副本和追随者副本，各自有不同的角色划分。副本是在分区层级下的，即每个分区可配置多个副本实现高可用。
生产者：Producer。向主题发布新消息的应用程序。
消费者：Consumer。从主题订阅新消息的应用程序。
消费者位移：Consumer Offset。表征消费者消费进度，每个消费者都有自己的消费者位移。
消费者组：Consumer Group。多个消费者实例组成的一个组，同时消费多个分区以实现高吞吐。
重平衡：Rebalance。消费者组内某个消费者实例挂掉之后

## 03 | Kafka只是消息引擎系统吗？ ##

## 04 | 我应该选择哪种Kafka？ ##

### 你知道几种Kafka？ ###

#### 1. Apache Kafka ####

#### 2. Conflunet Kafka ####

#### 3. Cloudera/Hortonworks Kafka ####

## 05 | 聊聊Kafka的版本号 ##

### Kafka版本命名 ###

### Kafka版本演进 ###

### 小结 ###

Kafka的版本号

* 0.7版本：只提供了最基础的消息队列功能。
* 0.8版本：引入了副本机制，至此Kafka成为了一个真正意义上完备的分布式高可靠消息队列解决方案
* 0.9.0.0版本：在呢国家了基础的安全认证/权限功能；使用Java重写了新版本消费者API；引入了Kafka Connect组件。
* 0.10.0.0版本：引入了KafkaStreams，正式升级成分布式流处理平台。
* 0.11.0.0版本：提供了幂等性ProducterAPI以及事务API；对Kafka消息格式做了重构。
* 1.0和2.0版本：主要还是KafkaStream的各种改进。

## 06 | Kafka线上集群部署方案 ##

### 操作系统 ###

Kafka由Scala语言和Java语言编写而成，编译之后的源代码就是普通的".class"文件。

* I/O模型的使用
* 数据网络传输效率
* 社区支持度

主流的I/O模型通常有5种类型：阻塞式I/O、非阻塞式I/O、I/O多路复用、信用驱动I/O和异步I/O。每个I/O模型都有各自典型的使用场景，比如Java中Socket对象的阻塞模式和非阻塞模式就对应前两种模型；而Linux中系统调用select函数就属于I/O多路复用模型；epoll系统调用则介于第三种和第四种模型之间；第五种模型，Linux系统支持，但Windows系统提供了一个叫IOCP线程模型属于这一种。

Kafka使用Java的selector，selector在Linux上的实现机制是epoll，而Windows平台上实现的机制是select。

Kafka生产和消费的消息都是通过网络传输的，而消息保存在磁盘。故kafka需要在磁盘和网络间进行大量数据传输。

零拷贝（Zero Copy）技术，就是当数据在磁盘和网络进行传输时

### 磁盘 ###

### 磁盘容量 ###

Kafka需要将消息保存在底层的磁盘上，

### 带宽 ###

### 小结 ###

|因素|考量点|建议|
|--|--|--|
|操作系统|操作系统I/O模型|将kafka部署在Linux系统上|
|磁盘|磁盘I/O模型|普通环境使用机械硬盘，不需要搭载RAID|
|磁盘容量|根据消息数、留存时间预估磁盘容量|实际使用中建议预留20%~30%的磁盘空间|
|带宽|根据实际带宽资源和业务SLA预估服务器数量|对于千兆网络，建议每台服务器按照700Mbps来计算，避免大流量下的丢包|

## 07、08 | 最最最重要的集群参数配置 ##

### Broker端参数 ###

log.dirs：在线上生产环境配置多个路径，

* 提升读写性能
* 能够实现故障转移



### 小结 ###

### Topic级别参数 ###

### JVM参数 ###

### 操作系统参数 ###

### 小结 ###

#### Broker端参数 ####

* 与存储信息相关的参数
* 与Zookeeper相关的参数
* 与Broker连接相关的参数
* 关于Topic管理的参数
* 关于数据留存的参数：`log.retention.{hour|minutes|ms}`、`log.retention.bytes`和`message.max.bytes`

#### Topic级别参数 ####

* retention.ms
* max.message.bytes：决定了Kafka Broker能够正常接收该Topic的最大消息大小。

#### JVM ####

* KAFKA_HEAP_OPTS：指定堆大小
* KAFKA_JVM_PERFORMANCE_OPTS：指定GC参数

#### 操作系统参数 ####

* 文件描述符限制
* 文件系统类型
* Swapping
* 提交时间

## 加餐 | 搭建开发环境、阅读源码方法、经典学习资料大揭秘 ##

### Kafka开发环境搭建 ###

第1步：安装Java和Gradle

第2步：下载Kafka的源码

## 结束语 | 以梦为马，莫负韶华！ ##

1. 持续精进自己的Java功底
2. 提升自己的Java多线程开发以及I/O开发能力
3. 掌握JVM调优和GC

* 真正的实践一定要包含你自己的思考和验证，而且曜与真是
* 在实际工作工程中，记录下遇到问题、解决问题的点点滴滴，并不断积累。
* 不重复犯错


