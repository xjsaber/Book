# 消息队列高手课 #

# 课前必读 #

## 开篇词|优秀的程序员，你的技术栈中不能只有“增删改查” ##

## 预习|怎样更好地学习这门课？ ##

# 基础篇 #

## 01 | 为什么需要消息队列 ##

## 02 | 该如何选择消息队列 ##

## 03 | 消息模型：主题和队列有什么区别？ ##

## 04 | 如何利用事务消息实现分布式事务？ ##

## 05 | 如何确保消息不会丢失？ ##

### 检测消息丢失的方法 ###

#### 我们可以利用消息队列的有序性来验证是否有消息丢失。 ####

### 确保消息可靠传递 ###

* 生产阶段：在这个阶段，从消息在Producer创建出来，经过网络传输发送到Broker端
* 存储阶段：在这个阶段，消息在Broker端存储，如果是集群，消息会在这个阶段被复制到其他的副本中。
* 消费阶段：在这个阶段，Consumer从Broker上拉去消息，经过网络传输发送到Consumer。

#### 1. 生产阶段 ####

**你在编写发送消息代码时，需要注意，正确处理返回值或者捕获异常，就可以保证这个阶段的消息不会丢失。**

#### 2. 存储阶段 ####

**如果对消息的可靠要求非常高，可以通过配置Broker参数来避免因为宏机丢消息**。

#### 3. 消费阶段 ####

不要在接收到消息后就立即发送消费确认

## 06 | 如何处理消费过程中的重复消息？ ##

### 消息重复的情况必然存在 ###

* At most once:至多一次。允许丢数据
* At least once：至少一次。不允许丢数据
* Exactly once：恰好一次

## 07 | 消息积压了该如何处理？ ##

### 优化性能来避免消息积压 ###

在消息的收发两端，我们的业务代码怎么和消息队列配合，达到一个最佳的性能。

#### 1. 发送端优化 ####

如果说，你的代码发送消息的性能上不去，你需要优先检查一下，是不是发消息之前的业务逻辑耗时太多导致的。

#### 2. 消费端性能优化 ####




### 消息积压了该如何处理？ ###

内置了监控的功能，只需要通过监控数据。如果是单位时间发送的消息增多。唯一的方法是通过扩容消费端的实例来提升总体消费水平。

如果段时间没有足够的服务器资源进行扩容 -> 将系统降级，通过关闭一些重要的业务，减少发送方发送的数据量，最低限度让系统正常运转。

监控发现，无论是发送消息的速度还是消费消息的速度和原来都没什么变化，需要检查一下你的消费端，是不是消费失败导致的一条消息反复消费这种情况比较多。

### 小结 ###

1. 是如何在消息队列的收发两端优化系统性能，提前预防消积压。
2. 当系统发生消息积压了之后，该如何处理。

优化消息收发性能，预防消息积压的方法有两种：

1. 增加批量
2. 增加开发

在发送端两种方法都可以使用，在消费端需要注意的是，增加并发需要同步扩容分区数量。

## 08 | 答疑解惑（一）：网关如何接收服务端的秒杀结果？ ##

# 进阶篇 #

## 09 | 学习开源代码该如何入手？ ##

### 通过文档来了解开源项目 ###

最佳的方式就是先看它的文档。

### 用以点带面的方式来阅读源码 ###

**带着问题去读源码，最好是带着问题的答案去读源码。**

* RocketMQ的消息是怎么写到文件里的？
* Kafka的Coordinator是怎么维护消息位置的？

### 小结 ###

学习它的代码，最佳的切入点是去读它的官方文档。

最佳的方式带着问题去阅读，最好是带着问题的答案去读，这样难度低、周期短、收获快。不要想着一定要从总体上去全面掌握一个项目的所有项目源代码。

### 思考题 ###

## 10 | 如何使用异步设计提升系统性能？ ##

### 异步设计如何提升系统性能？ ###

#### 1. 同步实现的性能瓶颈 ####

采用同步实现的方式，整个服务器的所有线程大部分时间都没有在工作，而是在等待。

#### 2. 采用异步实现解决等待问题 ####

* OnDebit()
* OnAllDone()

区别只是在线程模型由同步顺序调用改为了异步调用和回调。

### 简单实用的异步框架：CompletableFuture ###

### 小结 ###

当我们要执行一项比较耗时的操作时，不去等待操作结束，而是给这个操作一个命令：“当操作完成后，接下来去执行什么。”

使用异步编程模型，虽然并不能加快程序本身的速度，但可以减少或者避免线程等待，只用很少的线程就可以达到超高的吞吐能力。

使用异步模型，代码可读性和可维护性会下降

异步性能虽好，但一定不要滥用，只有类似在像消息队列这种业务逻辑简单并且需要超高吞吐量的场景下，或者必须长时间等待资源的地方，才考虑使用异步模型。如果系统的业务逻辑比较复杂，在性能足够满足业务需求的情况下，采用符合人类自然的思路且易于开发和维护的同步模型是更加明智的。

### 思考题 ###

#### 1. 没有攷虑失败如果第一次失败，第二次成功 ####



#### 2. OnComplete()方法是在什么线程中运行的 ####

主线程

## 11 | 如何实现高性能的异步网络传输？ ##

## 12 | 序列化与反序列化：如何通过网络传输结构化的数据？ ##

